# Техническая спецификация системы отзывов и рейтинга для WinePool

## 1. Анализ аналогов

### Vivino
- **Типы оценок:** 5-звездный рейтинг (1-5 звезд).
- **Поля отзыва:** Текст отзыва, фотографии, теги (ароматы, вкусы, стили вина).
- **Отображение на карточке товара:** Средний рейтинг с количеством отзывов, список отзывов с сортировкой по дате/полезности.
- **Взаимодействие:** Возможность лайкать отзывы, комментировать (ограниченно).

### OZON
- **Типы оценок:** 5-звездный рейтинг.
- **Поля отзыва:** Текст, фотографии, характеристики товара (для вин - вкусы, ароматы).
- **Отображение на карточке товара:** Средний рейтинг, количество отзывов, список с возможностью фильтрации по рейтингу.
- **Взаимодействие:** Комментарии продавца к отзывам, оценка полезности отзывов.

### Wildberries
- **Типы оценок:** 5-звездный рейтинг.
- **Поля отзыва:** Текст, фотографии, теги/характеристики.
- **Отображение на карточке товара:** Средний рейтинг, отзывы с фото, сортировка.
- **Взаимодействие:** Лайки отзывов, комментарии, возможность жаловаться на отзывы.

**Вывод для WinePool:** Использовать 5-звездный рейтинг, поля: текст, фото, теги (адаптированные под вино: fruity, dry, sweet, tannic и т.д.). Отображение среднего рейтинга на карточке, список отзывов с лайками и возможностью комментирования.

## 2. Модель данных

### Таблица `reviews` в Supabase
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wine_id UUID NOT NULL REFERENCES wines(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title TEXT,
  text TEXT NOT NULL,
  photos JSONB DEFAULT '[]'::jsonb, -- array of strings (image URLs)
  tags JSONB DEFAULT '[]'::jsonb, -- array of strings (e.g., ["fruity", "dry"])
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  is_deleted BOOLEAN DEFAULT FALSE
);

-- Indexes
CREATE INDEX idx_reviews_wine_id ON reviews(wine_id);
CREATE INDEX idx_reviews_user_id ON reviews(user_id);
CREATE INDEX idx_reviews_created_at ON reviews(created_at);
```

**Поля:**
- `id`: Уникальный идентификатор отзыва.
- `wine_id`: Ссылка на вино.
- `user_id`: Ссылка на пользователя.
- `rating`: Рейтинг от 1 до 5.
- `title`: Заголовок отзыва (опционально).
- `text`: Текст отзыва.
- `photos`: Массив URL фотографий (JSONB).
- `tags`: Массив тегов (JSONB).
- `created_at`, `updated_at`: Временные метки.
- `is_deleted`: Флаг мягкого удаления.

### Дополнение таблицы `wines`
Добавить поля для хранения вычисляемого рейтинга:
```sql
ALTER TABLE wines ADD COLUMN average_rating FLOAT DEFAULT 0.0;
ALTER TABLE wines ADD COLUMN review_count INTEGER DEFAULT 0;
```

## 3. Вычисляемый рейтинг
- **Метод расчета:** Среднее арифметическое рейтингов из отзывов (только активных, где `is_deleted = FALSE`).
- **Хранение:** В полях `average_rating` и `review_count` таблицы `wines`.
- **Логика обновления:**
  - При добавлении/обновлении/удалении отзыва пересчитывать средний рейтинг и количество отзывов для соответствующего вина.
  - Реализация: В коде приложения (Riverpod provider) после успешной операции с отзывом выполнять запрос на обновление `wines`.
  - Альтернатива: Supabase triggers для автоматического пересчета.

Пример SQL для пересчета:
```sql
UPDATE wines
SET average_rating = COALESCE((
  SELECT AVG(rating)::FLOAT
  FROM reviews
  WHERE wine_id = wines.id AND is_deleted = FALSE
), 0.0),
review_count = (
  SELECT COUNT(*)
  FROM reviews
  WHERE wine_id = wines.id AND is_deleted = FALSE
)
WHERE id = :wine_id;
```

## 4. UI/UX

### Форма добавления отзыва
- **Компоненты:**
  - `RatingBar`: Выбор рейтинга (5 звезд).
  - `TextField`: Многострочный ввод текста отзыва.
  - `ImagePicker`: Выбор нескольких фотографий (upload to Supabase Storage).
  - `Wrap` с `FilterChip`: Выбор тегов из предопределенного списка (fruity, dry, sweet, tannic, light, full-bodied, etc.).
  - `ElevatedButton`: "Опубликовать отзыв".
- **Валидация:** Рейтинг обязателен, текст не пустой.
- **Навигация:** Доступно из экрана детальной информации о вине (FAB или кнопка "Добавить отзыв").

### Отображение отзывов на экране вина
- **Карточка вина:** В верхней части - средний рейтинг (`RatingBar` + текст "4.5 (123 отзыва)").
- **Секция отзывов:**
  - `ListView` с пагинацией.
  - Каждый отзыв:
    - `Row`: Аватар пользователя, имя, дата, рейтинг (`RatingBar`).
    - Текст отзыва.
    - `Carousel` для фотографий (если есть).
    - `Wrap` с `Chip` для тегов.
    - `IconButton` для лайка (с счетчиком).
  - Сортировка: По дате (новые сверху), возможно фильтр по рейтингу.
- **Взаимодействие:** Пользователь может лайкать отзывы (таблица `review_likes` для отслеживания).

## 5. Дополнительные соображения
- **Безопасность:** Проверка, что пользователь не оставляет несколько отзывов на одно вино.
- **Производительность:** Кэширование среднего рейтинга, ленивая загрузка отзывов.
- **Модерация:** Возможность скрывать отзывы (is_deleted).
- **Интеграция:** Использовать Riverpod для state management, Supabase для данных.
- **Тестирование:** Unit tests для логики рейтинга, UI tests для форм.

## 6. Следующие шаги
- Создать миграции Supabase для таблиц.
- Реализовать providers в Riverpod.
- Разработать UI компоненты.
- Тестировать и интегрировать.